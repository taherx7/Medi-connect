<%- include('../partials/header') %>

    <div class="container">
        <div class="dashboard-grid">
            <aside class="sidebar">
                <h3>Menu</h3>
                <ul style="list-style: none; margin-top: 1rem;">
                    <li style="margin-bottom: 0.5rem;"><a href="#profile" style="text-decoration: none; color: var(--text);">Profile Settings</a></li>
                    <li style="margin-bottom: 0.5rem;"><a href="#appointments" style="text-decoration: none; color: var(--text);">Appointments</a></li>
                </ul>
            </aside>

            <div class="content">
                <h2 style="margin-bottom: 2rem;">Doctor Dashboard</h2>

                <section id="profile" style="margin-bottom: 3rem;">
                    <h3 style="margin-bottom: 1rem;">Profile Settings</h3>
                    <form action="/doctor/profile" method="POST" enctype="multipart/form-data" style="background: var(--surface); padding: 2rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div class="form-group">
                            <label>Profile Photo</label>
                            <% if (doctor.photos_url) { %>
                                <img src="<%= doctor.photos_url %>" alt="Profile" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-bottom: 1rem; display: block;">
                            <% } %>
                            <input type="file" name="photo" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label for="name">Name</label>
                            <input type="text" id="name" name="name" value="<%= doctor.name %>" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" name="phone" value="<%= doctor.phone || '' %>">
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" name="location" value="<%= doctor.location || '' %>">
                        </div>
                        <div class="form-group">
                            <label for="specialty">Specialty</label>
                            <input type="text" id="specialty" name="specialty" value="<%= doctor.specialty || '' %>" placeholder="e.g., Cardiologist, Dentist">
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" rows="4"><%= doctor.description || '' %></textarea>
                        </div>
                        <div class="form-group">
                            <label for="cost">Consultation Cost (DT)</label>
                            <input type="number" id="cost" name="cost" value="<%= doctor.cost || '' %>" placeholder="0">
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem;">Availability Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="working_hours_start">Start Time</label>
                                <input type="time" id="working_hours_start" name="working_hours_start" value="<%= doctor.working_hours_start || '' %>">
                            </div>
                            <div class="form-group">
                                <label for="working_hours_end">End Time</label>
                                <input type="time" id="working_hours_end" name="working_hours_end" value="<%= doctor.working_hours_end || '' %>">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="avg_consultation_time">Avg Consultation Time (minutes)</label>
                            <input type="number" id="avg_consultation_time" name="avg_consultation_time" value="<%= doctor.avg_consultation_time || 30 %>">
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>

                    <!-- Block Time Calendar -->
                    <div style="margin-top: 3rem; background: var(--surface); padding: 2rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 1rem;">Block Time Slots</h4>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">Reserve time slots when you're unavailable</p>
                        
                        <!-- Month/Year Selector -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <button onclick="changeMonth(-1)" class="btn btn-outline" type="button">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="calendar-month" style="margin: 0;"></h3>
                            <button onclick="changeMonth(1)" class="btn btn-outline" type="button">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Calendar Grid -->
                        <div id="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
                            <!-- Days of week -->
                            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light);">Sun</div>
                            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light);">Mon</div>
                            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light);">Tue</div>
                            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light);">Wed</div>
                            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light);">Thu</div>
                            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light);">Fri</div>
                            <div style="text-align: center; font-weight: 600; padding: 0.5rem; color: var(--text-light);">Sat</div>
                        </div>
                        
                        <!-- Time selection form -->
                        <form action="/doctor/block-time" method="POST">
                            <input type="hidden" id="selected_date" name="selected_date">
                            <div id="time-selector" style="display: none; border-top: 1px solid var(--border); padding-top: 1rem;">
                                <p style="margin-bottom: 1rem; color: var(--text); font-weight: 600;">
                                    Selected Date: <span id="display_date"></span>
                                </p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label for="block_start_time">Start Time</label>
                                        <input type="time" id="block_start_time" name="start_time" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="block_end_time">End Time</label>
                                        <input type="time" id="block_end_time" name="end_time" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-secondary">Block Selected Slot</button>
                            </div>
                        </form>
                    </div>

                    <!-- Delete Account -->
                    <div style="margin-top: 3rem; background: rgba(239, 68, 68, 0.05); padding: 2rem; border-radius: 0.5rem; border: 1px solid rgba(239, 68, 68, 0.2);">
                        <h4 style="margin-bottom: 1rem; color: var(--danger);">Danger Zone</h4>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem;">Once you delete your account, there is no going back. Please be certain.</p>
                        <button onclick="confirmDelete()" class="btn" style="background: var(--danger); color: white;">
                            <i class="fas fa-trash"></i> Delete Account
                        </button>
                    </div>
                </section>

                <section id="appointments">
                    <h3 style="margin-bottom: 1rem;">Upcoming Appointments</h3>
                    <% if (reservations.length > 0) { %>
                        <div style="background: var(--surface); border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8fafc; border-bottom: 1px solid var(--border);">
                                    <tr>
                                        <th style="padding: 1rem; text-align: left;">Patient</th>
                                        <th style="padding: 1rem; text-align: left;">Date & Time</th>
                                        <th style="padding: 1rem; text-align: left;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% reservations.forEach(res => { %>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <td style="padding: 1rem;">
                                                <div style="font-weight: 500;"><%= res.patient_name %></div>
                                                <div style="font-size: 0.85rem; color: var(--text-light);"><%= res.patient_email %></div>
                                            </td>
                                            <td style="padding: 1rem;">
                                                <%= new Date(res.time_slot).toLocaleString() %>
                                            </td>
                                            <td style="padding: 1rem;">
                                                <span style="padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.85rem; background: #dcfce7; color: #166534;">
                                                    <%= res.status %>
                                                </span>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <p>No appointments yet.</p>
                    <% } %>
                </section>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let selectedDate = null;

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Get calendar container (skip the header row)
            const calendar = document.getElementById('calendar');
            
            // Remove old day cells (keep header row)
            const dayCells = calendar.querySelectorAll('.day-cell');
            dayCells.forEach(cell => cell.remove());
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell';
                calendar.appendChild(emptyCell);
            }
            
            // Add day cells
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.textContent = day;
                
                const cellDate = new Date(year, month, day);
                const isPast = cellDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                
                if (isPast) {
                    dayCell.style.opacity = '0.3';
                    dayCell.style.cursor = 'not-allowed';
                } else {
                    dayCell.style.cursor = 'pointer';
                    dayCell.onclick = () => selectDate(year, month, day);
                }
                
                // Styling
                dayCell.style.padding = '0.75rem';
                dayCell.style.textAlign = 'center';
                dayCell.style.borderRadius = '0.5rem';
                dayCell.style.transition = 'all 0.2s';
                
                if (!isPast) {
                    dayCell.addEventListener('mouseenter', () => {
                        dayCell.style.background = 'var(--primary-light)';
                    });
                    dayCell.addEventListener('mouseleave', () => {
                        if (!selectedDate || selectedDate.getTime() !== cellDate.getTime()) {
                            dayCell.style.background = '';
                        }
                    });
                }
                
                calendar.appendChild(dayCell);
            }
        }

        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            
            // Update form
            const dateString = selectedDate.toISOString().split('T')[0];
            document.getElementById('selected_date').value = dateString;
            document.getElementById('display_date').textContent = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Show time selector
            document.getElementById('time-selector').style.display = 'block';
            
            // Update visual selection
            renderCalendar();
            const dayCells = document.querySelectorAll('.day-cell');
            dayCells.forEach(cell => {
                if (cell.textContent == day && !cell.style.opacity) {
                    cell.style.background = 'var(--primary)';
                    cell.style.color = 'white';
                }
            });
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function confirmDelete() {
            if (confirm('⚠️ Are you sure you want to delete your account? This action cannot be undone.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/doctor/delete';
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Initialize calendar on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar();
        });
    </script>

<%- include('../partials/footer') %>
